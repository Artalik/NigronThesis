From Formalisation Require Import SizeNat String.
From Formalisation Require Import Nom bin_combinators combinator multi.

Open Scope N_scope.

Inductive MessageCode :=
| SshMsgDisconnect
| SshMsgIgnore
| SshUnimplemented
| SshMsgDebug
| SshMsgServiceRequest
| SshMsgServiceAccept
| SshMsgKexinit
| SshMsgNewKeys
| SshMsgKexdhInit
| SshMsgKexdhReply
| SshMsgUndefined : nat8 -> MessageCode.

Definition MessageCode_from_u8 (value : nat8) : MessageCode :=
  match val value with
  | 1 => SshMsgDisconnect
  | 2 => SshMsgIgnore
  | 3 => SshUnimplemented
  | 4 => SshMsgDebug
  | 5 => SshMsgServiceRequest
  | 6 => SshMsgServiceAccept
  | 20 => SshMsgKexinit
  | 21 => SshMsgNewKeys
  | 30 => SshMsgKexdhInit
  | 31 => SshMsgKexdhReply
  | _ => SshMsgUndefined value
  end.

Record SshBanner :=
  mk_sshbanner {
      protover : span;
      swver : span;
    }.

Definition ssh_parse_banner : NomG SshBanner :=
  let! _ := tag "SSH-" in
  let! protover := is_not "-" in
  let! _ := char (ascii_to_nat8 "-") in
  let! swver := alt
                  (is_not (String " " (String "010"%char (String "013"%char EmptyString))))
                  rest in
  ret (mk_sshbanner protover swver).

Record SshRecordHeader :=
  mk_sshrecordheader {
      pkt_len : nat32;
      padding_len : nat8;
      msg_code : MessageCode
    }.

Definition ssh_parse_record_header : NomG SshRecordHeader :=
  let! pkt_len := verify be_u32 (fun v => 1 <? val v) in
  let! padding_len := be_u8 in
  let! msg_code := be_u8 in
  ret (mk_sshrecordheader pkt_len padding_len (MessageCode_from_u8 msg_code)).

Definition ssh_parse_record : NomG SshRecordHeader :=
  let! pkt_len := verify be_u32 (fun v => 1 <? val v) in
  let! padding_len := be_u8 in
  let! msg_code := be_u8 in
  let! _ := take (val pkt_len - 2) in
  ret (mk_sshrecordheader pkt_len padding_len (MessageCode_from_u8 msg_code)).

Record SshPacketKeyExchangeS (S : Type) :=
  mk_sshpacketkeyexchange {
      cookie : S;
      kex_algs : S;
      server_host_key_algs : S;
      encr_algs_client_to_server : S;
      encr_algs_server_to_client : S;
      max_algs_client_to_server : S;
      max_algs_server_to_client : S;
      comp_algs_client_to_server : S;
      comp_algs_server_to_client : S;
      langs_client_to_server : S;
      langs_server_to_client : S;
      first_kex_packet_follows : nat8;
      reserved : nat32
    }.

Definition SshPacketKeyExchange := SshPacketKeyExchangeS span.

Arguments mk_sshpacketkeyexchange [S].

Definition SSH_HASSH_STRING_DELIMITER_SLICE : nat8 := ascii_to_nat8 ";".

Definition parse_string : NomG span := length_data (let! v := be_u32 in
                                                   ret (val v)).

Definition usize_16 := 16.

Definition ssh_parse_key_exchange : NomG SshPacketKeyExchange :=
  let! cookie := take usize_16 in
  let! kex_algs := parse_string in
  let! server_host_key_algs := parse_string in
  let! encr_algs_client_to_server := parse_string in
  let! encr_algs_server_to_client := parse_string in
  let! max_algs_client_to_server := parse_string in
  let! max_algs_server_to_client := parse_string in
  let! comp_algs_client_to_server := parse_string in
  let! comp_algs_server_to_client := parse_string in
  let! langs_client_to_server := parse_string in
  let! langs_server_to_client := parse_string in
  let! first_kex_packet_follows := be_u8 in
  let! reserved := be_u32 in
  ret (mk_sshpacketkeyexchange
         cookie
         kex_algs
         server_host_key_algs
         encr_algs_client_to_server
         encr_algs_server_to_client
         max_algs_client_to_server
         max_algs_server_to_client
         comp_algs_client_to_server
         comp_algs_server_to_client
         langs_client_to_server
         langs_server_to_client
         first_kex_packet_follows
         reserved).

Definition string_to_list8 (s : string):=
  List.map ascii_to_nat8 (list_ascii_of_string s).

Definition test1 := "SSH-Single-".

Compute (run 7 ssh_parse_banner
             (string_to_list8 test1) (mk_span 0 (string_length test1))).

Definition test2 := "SSH-2.0-Soft".

Compute (run 5 ssh_parse_banner
             (string_to_list8 test2) (mk_span 0 (string_length test2)) ).

#[tactic = "NSize"] Equations test_client_key_exchange : list nat8 :=
  test_client_key_exchange :=
  [(_8 24); (_8 112); (_8 203); (_8 164); (_8 163); (_8 212); (_8 220); (_8 136); (_8 111);
   (_8 253); (_8 118); (_8 6); (_8 207); (_8 54); (_8 27); (_8 198); (_8 0); (_8 0); (_8 1); (_8 13); (_8 99); (_8 117); (_8 114); (_8 118);
   (_8 101); (_8 50); (_8 53); (_8 53); (_8 49); (_8 57); (_8 45); (_8 115); (_8 104); (_8 97); (_8 50); (_8 53); (_8 54); (_8 44); (_8 99);
   (_8 117); (_8 114); (_8 118); (_8 101); (_8 50); (_8 53); (_8 53); (_8 49); (_8 57); (_8 45); (_8 115); (_8 104); (_8 97); (_8 50); (_8 53);
   (_8 54); (_8 64); (_8 108); (_8 105); (_8 98); (_8 115); (_8 115); (_8 104); (_8 46); (_8 111); (_8 114); (_8 103); (_8 44); (_8 101); (_8 99);
   (_8 100); (_8 104); (_8 45); (_8 115); (_8 104); (_8 97); (_8 50); (_8 45); (_8 110); (_8 105); (_8 115); (_8 116); (_8 112); (_8 50); (_8 53);
   (_8 54); (_8 44); (_8 101); (_8 99); (_8 100); (_8 104); (_8 45); (_8 115); (_8 104); (_8 97); (_8 50); (_8 45); (_8 110); (_8 105); (_8 115);
   (_8 116); (_8 112); (_8 51); (_8 56); (_8 52); (_8 44); (_8 101); (_8 99); (_8 100); (_8 104); (_8 45); (_8 115); (_8 104); (_8 97); (_8 50);
   (_8 45); (_8 110); (_8 105); (_8 115); (_8 116); (_8 112); (_8 53); (_8 50); (_8 49); (_8 44); (_8 100); (_8 105); (_8 102); (_8 102); (_8 105);
   (_8 101); (_8 45); (_8 104); (_8 101); (_8 108); (_8 108); (_8 109); (_8 97); (_8 110); (_8 45); (_8 103); (_8 114); (_8 111); (_8 117); (_8 112);
   (_8 45); (_8 101); (_8 120); (_8 99); (_8 104); (_8 97); (_8 110); (_8 103); (_8 101); (_8 45); (_8 115); (_8 104); (_8 97); (_8 50); (_8 53);
   (_8 54); (_8 44); (_8 100); (_8 105); (_8 102); (_8 102); (_8 105); (_8 101); (_8 45); (_8 104); (_8 101); (_8 108); (_8 108); (_8 109); (_8 97);
   (_8 110); (_8 45); (_8 103); (_8 114); (_8 111); (_8 117); (_8 112); (_8 49); (_8 54); (_8 45); (_8 115); (_8 104); (_8 97); (_8 53); (_8 49);
   (_8 50); (_8 44); (_8 100); (_8 105); (_8 102); (_8 102); (_8 105); (_8 101); (_8 45); (_8 104); (_8 101); (_8 108); (_8 108); (_8 109); (_8 97);
   (_8 110); (_8 45); (_8 103); (_8 114); (_8 111); (_8 117); (_8 112); (_8 49); (_8 56); (_8 45); (_8 115); (_8 104); (_8 97); (_8 53); (_8 49);
   (_8 50); (_8 44); (_8 100); (_8 105); (_8 102); (_8 102); (_8 105); (_8 101); (_8 45); (_8 104); (_8 101); (_8 108); (_8 108); (_8 109); (_8 97);
   (_8 110); (_8 45); (_8 103); (_8 114); (_8 111); (_8 117); (_8 112); (_8 49); (_8 52); (_8 45); (_8 115); (_8 104); (_8 97); (_8 50); (_8 53);
   (_8 54); (_8 44); (_8 100); (_8 105); (_8 102); (_8 102); (_8 105); (_8 101); (_8 45); (_8 104); (_8 101); (_8 108); (_8 108); (_8 109); (_8 97);
   (_8 110); (_8 45); (_8 103); (_8 114); (_8 111); (_8 117); (_8 112); (_8 49); (_8 52); (_8 45); (_8 115); (_8 104); (_8 97); (_8 49); (_8 44);
   (_8 101); (_8 120); (_8 116); (_8 45); (_8 105); (_8 110); (_8 102); (_8 111); (_8 45); (_8 99); (_8 0); (_8 0); (_8 1); (_8 102); (_8 101);
   (_8 99); (_8 100); (_8 115); (_8 97); (_8 45); (_8 115); (_8 104); (_8 97); (_8 50); (_8 45); (_8 110); (_8 105); (_8 115); (_8 116); (_8 112);
   (_8 50); (_8 53); (_8 54); (_8 45); (_8 99); (_8 101); (_8 114); (_8 116); (_8 45); (_8 118); (_8 48); (_8 49); (_8 64); (_8 111); (_8 112);
   (_8 101); (_8 110); (_8 115); (_8 115); (_8 104); (_8 46); (_8 99); (_8 111); (_8 109); (_8 44); (_8 101); (_8 99); (_8 100); (_8 115); (_8 97);
   (_8 45); (_8 115); (_8 104); (_8 97); (_8 50); (_8 45); (_8 110); (_8 105); (_8 115); (_8 116); (_8 112); (_8 51); (_8 56); (_8 52); (_8 45);
   (_8 99); (_8 101); (_8 114); (_8 116); (_8 45); (_8 118); (_8 48); (_8 49); (_8 64); (_8 111); (_8 112); (_8 101); (_8 110); (_8 115); (_8 115);
   (_8 104); (_8 46); (_8 99); (_8 111); (_8 109); (_8 44); (_8 101); (_8 99); (_8 100); (_8 115); (_8 97); (_8 45); (_8 115); (_8 104); (_8 97);
   (_8 50); (_8 45); (_8 110); (_8 105); (_8 115); (_8 116); (_8 112); (_8 53); (_8 50); (_8 49); (_8 45); (_8 99); (_8 101); (_8 114); (_8 116);
   (_8 45); (_8 118); (_8 48); (_8 49); (_8 64); (_8 111); (_8 112); (_8 101); (_8 110); (_8 115); (_8 115); (_8 104); (_8 46); (_8 99); (_8 111);
   (_8 109); (_8 44); (_8 101); (_8 99); (_8 100); (_8 115); (_8 97); (_8 45); (_8 115); (_8 104); (_8 97); (_8 50); (_8 45); (_8 110); (_8 105);
   (_8 115); (_8 116); (_8 112); (_8 50); (_8 53); (_8 54); (_8 44); (_8 101); (_8 99); (_8 100); (_8 115); (_8 97); (_8 45); (_8 115); (_8 104);
   (_8 97); (_8 50); (_8 45); (_8 110); (_8 105); (_8 115); (_8 116); (_8 112); (_8 51); (_8 56); (_8 52); (_8 44); (_8 101); (_8 99); (_8 100);
   (_8 115); (_8 97); (_8 45); (_8 115); (_8 104); (_8 97); (_8 50); (_8 45); (_8 110); (_8 105); (_8 115); (_8 116); (_8 112); (_8 53); (_8 50);
   (_8 49); (_8 44); (_8 115); (_8 115); (_8 104); (_8 45); (_8 101); (_8 100); (_8 50); (_8 53); (_8 53); (_8 49); (_8 57); (_8 45); (_8 99);
   (_8 101); (_8 114); (_8 116); (_8 45); (_8 118); (_8 48); (_8 49); (_8 64); (_8 111); (_8 112); (_8 101); (_8 110); (_8 115); (_8 115); (_8 104);
   (_8 46); (_8 99); (_8 111); (_8 109); (_8 44); (_8 114); (_8 115); (_8 97); (_8 45); (_8 115); (_8 104); (_8 97); (_8 50); (_8 45); (_8 53);
   (_8 49); (_8 50); (_8 45); (_8 99); (_8 101); (_8 114); (_8 116); (_8 45); (_8 118); (_8 48); (_8 49); (_8 64); (_8 111); (_8 112); (_8 101);
   (_8 110); (_8 115); (_8 115); (_8 104); (_8 46); (_8 99); (_8 111); (_8 109); (_8 44); (_8 114); (_8 115); (_8 97); (_8 45); (_8 115); (_8 104);
   (_8 97); (_8 50); (_8 45); (_8 50); (_8 53); (_8 54); (_8 45); (_8 99); (_8 101); (_8 114); (_8 116); (_8 45); (_8 118); (_8 48); (_8 49);
   (_8 64); (_8 111); (_8 112); (_8 101); (_8 110); (_8 115); (_8 115); (_8 104); (_8 46); (_8 99); (_8 111); (_8 109); (_8 44); (_8 115); (_8 115);
   (_8 104); (_8 45); (_8 114); (_8 115); (_8 97); (_8 45); (_8 99); (_8 101); (_8 114); (_8 116); (_8 45); (_8 118); (_8 48); (_8 49); (_8 64);
   (_8 111); (_8 112); (_8 101); (_8 110); (_8 115); (_8 115); (_8 104); (_8 46); (_8 99); (_8 111); (_8 109); (_8 44); (_8 115); (_8 115); (_8 104);
   (_8 45); (_8 101); (_8 100); (_8 50); (_8 53); (_8 53); (_8 49); (_8 57); (_8 44); (_8 114); (_8 115); (_8 97); (_8 45); (_8 115); (_8 104);
   (_8 97); (_8 50); (_8 45); (_8 53); (_8 49); (_8 50); (_8 44); (_8 114); (_8 115); (_8 97); (_8 45); (_8 115); (_8 104); (_8 97); (_8 50);
   (_8 45); (_8 50); (_8 53); (_8 54); (_8 44); (_8 115); (_8 115); (_8 104); (_8 45); (_8 114); (_8 115); (_8 97); (_8 0); (_8 0); (_8 0);
   (_8 108); (_8 99); (_8 104); (_8 97); (_8 99); (_8 104); (_8 97); (_8 50); (_8 48); (_8 45); (_8 112); (_8 111); (_8 108); (_8 121); (_8 49);
   (_8 51); (_8 48); (_8 53); (_8 64); (_8 111); (_8 112); (_8 101); (_8 110); (_8 115); (_8 115); (_8 104); (_8 46); (_8 99); (_8 111); (_8 109);
   (_8 44); (_8 97); (_8 101); (_8 115); (_8 49); (_8 50); (_8 56); (_8 45); (_8 99); (_8 116); (_8 114); (_8 44); (_8 97); (_8 101); (_8 115);
   (_8 49); (_8 57); (_8 50); (_8 45); (_8 99); (_8 116); (_8 114); (_8 44); (_8 97); (_8 101); (_8 115); (_8 50); (_8 53); (_8 54); (_8 45);
   (_8 99); (_8 116); (_8 114); (_8 44); (_8 97); (_8 101); (_8 115); (_8 49); (_8 50); (_8 56); (_8 45); (_8 103); (_8 99); (_8 109); (_8 64);
   (_8 111); (_8 112); (_8 101); (_8 110); (_8 115); (_8 115); (_8 104); (_8 46); (_8 99); (_8 111); (_8 109); (_8 44); (_8 97); (_8 101); (_8 115);
   (_8 50); (_8 53); (_8 54); (_8 45); (_8 103); (_8 99); (_8 109); (_8 64); (_8 111); (_8 112); (_8 101); (_8 110); (_8 115); (_8 115); (_8 104);
   (_8 46); (_8 99); (_8 111); (_8 109); (_8 0); (_8 0); (_8 0); (_8 108); (_8 99); (_8 104); (_8 97); (_8 99); (_8 104); (_8 97); (_8 50);
   (_8 48); (_8 45); (_8 112); (_8 111); (_8 108); (_8 121); (_8 49); (_8 51); (_8 48); (_8 53); (_8 64); (_8 111); (_8 112); (_8 101); (_8 110);
   (_8 115); (_8 115); (_8 104); (_8 46); (_8 99); (_8 111); (_8 109); (_8 44); (_8 97); (_8 101); (_8 115); (_8 49); (_8 50); (_8 56); (_8 45);
   (_8 99); (_8 116); (_8 114); (_8 44); (_8 97); (_8 101); (_8 115); (_8 49); (_8 57); (_8 50); (_8 45); (_8 99); (_8 116); (_8 114); (_8 44);
   (_8 97); (_8 101); (_8 115); (_8 50); (_8 53); (_8 54); (_8 45); (_8 99); (_8 116); (_8 114); (_8 44); (_8 97); (_8 101); (_8 115); (_8 49);
   (_8 50); (_8 56); (_8 45); (_8 103); (_8 99); (_8 109); (_8 64); (_8 111); (_8 112); (_8 101); (_8 110); (_8 115); (_8 115); (_8 104); (_8 46);
   (_8 99); (_8 111); (_8 109); (_8 44); (_8 97); (_8 101); (_8 115); (_8 50); (_8 53); (_8 54); (_8 45); (_8 103); (_8 99); (_8 109); (_8 64);
   (_8 111); (_8 112); (_8 101); (_8 110); (_8 115); (_8 115); (_8 104); (_8 46); (_8 99); (_8 111); (_8 109); (_8 0); (_8 0); (_8 0); (_8 213);
   (_8 117); (_8 109); (_8 97); (_8 99); (_8 45); (_8 54); (_8 52); (_8 45); (_8 101); (_8 116); (_8 109); (_8 64); (_8 111); (_8 112); (_8 101);
   (_8 110); (_8 115); (_8 115); (_8 104); (_8 46); (_8 99); (_8 111); (_8 109); (_8 44); (_8 117); (_8 109); (_8 97); (_8 99); (_8 45); (_8 49);
   (_8 50); (_8 56); (_8 45); (_8 101); (_8 116); (_8 109); (_8 64); (_8 111); (_8 112); (_8 101); (_8 110); (_8 115); (_8 115); (_8 104); (_8 46);
   (_8 99); (_8 111); (_8 109); (_8 44); (_8 104); (_8 109); (_8 97); (_8 99); (_8 45); (_8 115); (_8 104); (_8 97); (_8 50); (_8 45); (_8 50);
   (_8 53); (_8 54); (_8 45); (_8 101); (_8 116); (_8 109); (_8 64); (_8 111); (_8 112); (_8 101); (_8 110); (_8 115); (_8 115); (_8 104); (_8 46);
   (_8 99); (_8 111); (_8 109); (_8 44); (_8 104); (_8 109); (_8 97); (_8 99); (_8 45); (_8 115); (_8 104); (_8 97); (_8 50); (_8 45); (_8 53);
   (_8 49); (_8 50); (_8 45); (_8 101); (_8 116); (_8 109); (_8 64); (_8 111); (_8 112); (_8 101); (_8 110); (_8 115); (_8 115); (_8 104); (_8 46);
   (_8 99); (_8 111); (_8 109); (_8 44); (_8 104); (_8 109); (_8 97); (_8 99); (_8 45); (_8 115); (_8 104); (_8 97); (_8 49); (_8 45); (_8 101);
   (_8 116); (_8 109); (_8 64); (_8 111); (_8 112); (_8 101); (_8 110); (_8 115); (_8 115); (_8 104); (_8 46); (_8 99); (_8 111); (_8 109); (_8 44);
   (_8 117); (_8 109); (_8 97); (_8 99); (_8 45); (_8 54); (_8 52); (_8 64); (_8 111); (_8 112); (_8 101); (_8 110); (_8 115); (_8 115); (_8 104);
   (_8 46); (_8 99); (_8 111); (_8 109); (_8 44); (_8 117); (_8 109); (_8 97); (_8 99); (_8 45); (_8 49); (_8 50); (_8 56); (_8 64); (_8 111);
   (_8 112); (_8 101); (_8 110); (_8 115); (_8 115); (_8 104); (_8 46); (_8 99); (_8 111); (_8 109); (_8 44); (_8 104); (_8 109); (_8 97); (_8 99);
   (_8 45); (_8 115); (_8 104); (_8 97); (_8 50); (_8 45); (_8 50); (_8 53); (_8 54); (_8 44); (_8 104); (_8 109); (_8 97); (_8 99); (_8 45);
   (_8 115); (_8 104); (_8 97); (_8 50); (_8 45); (_8 53); (_8 49); (_8 50); (_8 44); (_8 104); (_8 109); (_8 97); (_8 99); (_8 45); (_8 115);
   (_8 104); (_8 97); (_8 49); (_8 0); (_8 0); (_8 0); (_8 213); (_8 117); (_8 109); (_8 97); (_8 99); (_8 45); (_8 54); (_8 52); (_8 45);
   (_8 101); (_8 116); (_8 109); (_8 64); (_8 111); (_8 112); (_8 101); (_8 110); (_8 115); (_8 115); (_8 104); (_8 46); (_8 99); (_8 111); (_8 109);
   (_8 44); (_8 117); (_8 109); (_8 97); (_8 99); (_8 45); (_8 49); (_8 50); (_8 56); (_8 45); (_8 101); (_8 116); (_8 109); (_8 64); (_8 111);
   (_8 112); (_8 101); (_8 110); (_8 115); (_8 115); (_8 104); (_8 46); (_8 99); (_8 111); (_8 109); (_8 44); (_8 104); (_8 109); (_8 97); (_8 99);
   (_8 45); (_8 115); (_8 104); (_8 97); (_8 50); (_8 45); (_8 50); (_8 53); (_8 54); (_8 45); (_8 101); (_8 116); (_8 109); (_8 64); (_8 111);
   (_8 112); (_8 101); (_8 110); (_8 115); (_8 115); (_8 104); (_8 46); (_8 99); (_8 111); (_8 109); (_8 44); (_8 104); (_8 109); (_8 97); (_8 99);
   (_8 45); (_8 115); (_8 104); (_8 97); (_8 50); (_8 45); (_8 53); (_8 49); (_8 50); (_8 45); (_8 101); (_8 116); (_8 109); (_8 64); (_8 111);
   (_8 112); (_8 101); (_8 110); (_8 115); (_8 115); (_8 104); (_8 46); (_8 99); (_8 111); (_8 109); (_8 44); (_8 104); (_8 109); (_8 97); (_8 99);
   (_8 45); (_8 115); (_8 104); (_8 97); (_8 49); (_8 45); (_8 101); (_8 116); (_8 109); (_8 64); (_8 111); (_8 112); (_8 101); (_8 110); (_8 115);
   (_8 115); (_8 104); (_8 46); (_8 99); (_8 111); (_8 109); (_8 44); (_8 117); (_8 109); (_8 97); (_8 99); (_8 45); (_8 54); (_8 52); (_8 64);
   (_8 111); (_8 112); (_8 101); (_8 110); (_8 115); (_8 115); (_8 104); (_8 46); (_8 99); (_8 111); (_8 109); (_8 44); (_8 117); (_8 109); (_8 97);
   (_8 99); (_8 45); (_8 49); (_8 50); (_8 56); (_8 64); (_8 111); (_8 112); (_8 101); (_8 110); (_8 115); (_8 115); (_8 104); (_8 46); (_8 99);
   (_8 111); (_8 109); (_8 44); (_8 104); (_8 109); (_8 97); (_8 99); (_8 45); (_8 115); (_8 104); (_8 97); (_8 50); (_8 45); (_8 50); (_8 53);
   (_8 54); (_8 44); (_8 104); (_8 109); (_8 97); (_8 99); (_8 45); (_8 115); (_8 104); (_8 97); (_8 50); (_8 45); (_8 53); (_8 49); (_8 50);
   (_8 44); (_8 104); (_8 109); (_8 97); (_8 99); (_8 45); (_8 115); (_8 104); (_8 97); (_8 49); (_8 0); (_8 0); (_8 0); (_8 26); (_8 110);
   (_8 111); (_8 110); (_8 101); (_8 44); (_8 122); (_8 108); (_8 105); (_8 98); (_8 64); (_8 111); (_8 112); (_8 101); (_8 110); (_8 115); (_8 115);
   (_8 104); (_8 46); (_8 99); (_8 111); (_8 109); (_8 44); (_8 122); (_8 108); (_8 105); (_8 98); (_8 0); (_8 0); (_8 0); (_8 26); (_8 110);
   (_8 111); (_8 110); (_8 101); (_8 44); (_8 122); (_8 108); (_8 105); (_8 98); (_8 64); (_8 111); (_8 112); (_8 101); (_8 110); (_8 115); (_8 115);
   (_8 104); (_8 46); (_8 99); (_8 111); (_8 109); (_8 44); (_8 122); (_8 108); (_8 105); (_8 98); (_8 0); (_8 0); (_8 0); (_8 0); (_8 0);
   (_8 0); (_8 0); (_8 0); (_8 0); (_8 0); (_8 0); (_8 0); (_8 0)].

#[tactic = "NSize"] Equations test_cookie : list nat8 :=
  test_cookie := [(_8 24); (_8 112); (_8 203); (_8 164); (_8 163); (_8 212); (_8 220); (_8 136); (_8 111); (_8 253); (_8 118); (_8 6); (_8 207); (_8 54); (_8 27); (_8 198)].

(*     = Res
         ({| pos := 1382; len := 0 |},
         {|
           cookie := {| pos := 0; len := 16 |};
           kex_algs := {| pos := 20; len := 269 |};
           server_host_key_algs := {| pos := 293; len := 358 |};
           encr_algs_client_to_server := {| pos := 655; len := 108 |};
           encr_algs_server_to_client := {| pos := 767; len := 108 |};
           max_algs_client_to_server := {| pos := 879; len := 213 |};
           max_algs_server_to_client := {| pos := 1096; len := 213 |};
           comp_algs_client_to_server := {| pos := 1313; len := 26 |};
           comp_algs_server_to_client := {| pos := 1343; len := 26 |};
           langs_client_to_server := {| pos := 1373; len := 0 |};
           langs_server_to_client := {| pos := 1377; len := 0 |};
           first_kex_packet_follows := _8 0;
           reserved := _32 0
         |})
     : Result (span * SshPacketKeyExchange)
 *)
Compute (run 101 ssh_parse_key_exchange
           test_client_key_exchange
           (mk_span 0 (N.of_nat (List.length test_client_key_exchange)))).

#[tactic = "NSize"] Equations test_malicious : list nat8 :=
  test_malicious :=
  [(_8 125); (_8 118); (_8 79); (_8 120); (_8 129); (_8 158); (_8 16); (_8 250); (_8 35); (_8 114);
   (_8 181); (_8 21); (_8 86); (_8 186); (_8 249); (_8 70); (_8 0); (_8 0); (_8 1); (_8 2); (_8 117); (_8 114); (_8 118); (_8 101); (_8 50);
   (_8 53); (_8 53); (_8 49); (_8 57); (_8 45); (_8 115); (_8 104); (_8 97); (_8 50); (_8 53); (_8 54); (_8 44); (_8 99); (_8 117); (_8 114); (_8 118);
   (_8 101); (_8 50); (_8 53); (_8 53); (_8 49); (_8 57); (_8 45); (_8 115); (_8 104); (_8 97); (_8 50); (_8 53); (_8 54); (_8 64); (_8 108); (_8 105);
   (_8 98); (_8 115); (_8 115); (_8 104); (_8 46); (_8 111); (_8 114); (_8 103); (_8 44); (_8 101); (_8 99); (_8 100); (_8 104); (_8 45); (_8 115); (_8 104);
   (_8 97); (_8 50); (_8 45); (_8 110); (_8 105); (_8 115); (_8 116); (_8 112); (_8 50); (_8 53); (_8 54); (_8 44); (_8 101); (_8 99); (_8 100); (_8 104);
   (_8 45); (_8 115); (_8 104); (_8 97); (_8 50); (_8 45); (_8 110); (_8 105); (_8 115); (_8 116); (_8 112); (_8 51); (_8 56); (_8 52); (_8 44); (_8 101);
   (_8 99); (_8 100); (_8 104); (_8 45); (_8 115); (_8 104); (_8 97); (_8 50); (_8 45); (_8 110); (_8 105); (_8 115); (_8 116); (_8 112); (_8 53); (_8 50);
   (_8 49); (_8 44); (_8 100); (_8 105); (_8 102); (_8 102); (_8 105); (_8 101); (_8 45); (_8 104); (_8 101); (_8 108); (_8 108); (_8 109); (_8 97); (_8 110);
   (_8 45); (_8 103); (_8 114); (_8 111); (_8 117); (_8 112); (_8 45); (_8 101); (_8 120); (_8 99); (_8 104); (_8 97); (_8 110); (_8 103); (_8 101); (_8 45);
   (_8 115); (_8 104); (_8 97); (_8 50); (_8 53); (_8 54); (_8 44); (_8 100); (_8 105); (_8 102); (_8 102); (_8 105); (_8 101); (_8 45); (_8 104); (_8 101);
   (_8 108); (_8 108); (_8 109); (_8 97); (_8 110); (_8 45); (_8 103); (_8 114); (_8 111); (_8 117); (_8 112); (_8 49); (_8 54); (_8 45); (_8 115); (_8 104);
   (_8 97); (_8 53); (_8 49); (_8 50); (_8 44); (_8 100); (_8 105); (_8 102); (_8 102); (_8 105); (_8 101); (_8 45); (_8 104); (_8 101); (_8 108); (_8 108);
   (_8 109); (_8 97); (_8 110); (_8 45); (_8 103); (_8 114); (_8 111); (_8 117); (_8 112); (_8 49); (_8 56); (_8 45); (_8 115); (_8 104); (_8 97); (_8 53);
   (_8 49); (_8 50); (_8 44); (_8 100); (_8 105); (_8 102); (_8 102); (_8 105); (_8 101); (_8 45); (_8 104); (_8 101); (_8 108); (_8 108); (_8 109); (_8 97);
   (_8 110); (_8 45); (_8 103); (_8 114); (_8 111); (_8 117); (_8 112); (_8 49); (_8 52); (_8 45); (_8 115); (_8 104); (_8 97); (_8 50); (_8 53); (_8 54);
   (_8 44); (_8 100); (_8 105); (_8 102); (_8 102); (_8 105); (_8 101); (_8 45); (_8 104); (_8 101); (_8 108); (_8 108); (_8 109); (_8 97); (_8 110); (_8 45);
   (_8 103); (_8 114); (_8 111); (_8 117); (_8 112); (_8 49); (_8 52); (_8 45); (_8 115); (_8 104); (_8 97); (_8 49); (_8 0); (_8 0); (_8 0); (_8 65);
   (_8 115); (_8 115); (_8 104); (_8 45); (_8 114); (_8 115); (_8 97); (_8 44); (_8 114); (_8 115); (_8 97); (_8 45); (_8 115); (_8 104); (_8 97); (_8 50);
   (_8 45); (_8 53); (_8 49); (_8 50); (_8 44); (_8 114); (_8 115); (_8 97); (_8 45); (_8 115); (_8 104); (_8 97); (_8 50); (_8 45); (_8 50); (_8 53);
   (_8 54); (_8 44); (_8 101); (_8 99); (_8 100); (_8 115); (_8 97); (_8 45); (_8 115); (_8 104); (_8 97); (_8 50); (_8 45); (_8 110); (_8 105); (_8 115);
   (_8 116); (_8 112); (_8 50); (_8 53); (_8 54); (_8 44); (_8 115); (_8 115); (_8 104); (_8 45); (_8 101); (_8 100); (_8 50); (_8 53); (_8 53); (_8 49);
   (_8 57); (_8 0); (_8 0); (_8 0); (_8 108); (_8 99); (_8 104); (_8 97); (_8 99); (_8 104); (_8 97); (_8 50); (_8 48); (_8 45); (_8 112); (_8 111);
   (_8 108); (_8 121); (_8 49); (_8 51); (_8 48); (_8 53); (_8 64); (_8 111); (_8 112); (_8 101); (_8 110); (_8 115); (_8 115); (_8 104); (_8 46); (_8 99);
   (_8 111); (_8 109); (_8 44); (_8 97); (_8 101); (_8 115); (_8 49); (_8 50); (_8 56); (_8 45); (_8 99); (_8 116); (_8 114); (_8 44); (_8 97); (_8 101);
   (_8 115); (_8 49); (_8 57); (_8 50); (_8 45); (_8 99); (_8 116); (_8 114); (_8 44); (_8 97); (_8 101); (_8 115); (_8 50); (_8 53); (_8 54); (_8 45);
   (_8 99); (_8 116); (_8 114); (_8 44); (_8 97); (_8 101); (_8 115); (_8 49); (_8 50); (_8 56); (_8 45); (_8 103); (_8 99); (_8 109); (_8 64); (_8 111);
   (_8 112); (_8 101); (_8 110); (_8 115); (_8 115); (_8 104); (_8 46); (_8 99); (_8 111); (_8 109); (_8 44); (_8 97); (_8 101); (_8 115); (_8 50); (_8 53);
   (_8 54); (_8 45); (_8 103); (_8 99); (_8 109); (_8 64); (_8 111); (_8 112); (_8 101); (_8 110); (_8 115); (_8 115); (_8 104); (_8 46); (_8 99); (_8 111);
   (_8 109); (_8 0); (_8 0); (_8 0); (_8 108); (_8 99); (_8 104); (_8 97); (_8 99); (_8 104); (_8 97); (_8 50); (_8 48); (_8 45); (_8 112); (_8 111);
   (_8 108); (_8 121); (_8 49); (_8 51); (_8 48); (_8 53); (_8 64); (_8 111); (_8 112); (_8 101); (_8 110); (_8 115); (_8 115); (_8 104); (_8 46); (_8 99);
   (_8 111); (_8 109); (_8 44); (_8 97); (_8 101); (_8 115); (_8 49); (_8 50); (_8 56); (_8 45); (_8 99); (_8 116); (_8 114); (_8 44); (_8 97); (_8 101);
   (_8 115); (_8 49); (_8 57); (_8 50); (_8 45); (_8 99); (_8 116); (_8 114); (_8 44); (_8 97); (_8 101); (_8 115); (_8 50); (_8 53); (_8 54); (_8 45);
   (_8 99); (_8 116); (_8 114); (_8 44); (_8 97); (_8 101); (_8 115); (_8 49); (_8 50); (_8 56); (_8 45); (_8 103); (_8 99); (_8 109); (_8 64); (_8 111);
   (_8 112); (_8 101); (_8 110); (_8 115); (_8 115); (_8 104); (_8 46); (_8 99); (_8 111); (_8 109); (_8 44); (_8 97); (_8 101); (_8 115); (_8 50); (_8 53);
   (_8 54); (_8 45); (_8 103); (_8 99); (_8 109); (_8 64); (_8 111); (_8 112); (_8 101); (_8 110); (_8 115); (_8 115); (_8 104); (_8 46); (_8 99); (_8 111);
   (_8 109); (_8 0); (_8 0); (_8 0); (_8 213); (_8 117); (_8 109); (_8 97); (_8 99); (_8 45); (_8 54); (_8 52); (_8 45); (_8 101); (_8 116); (_8 109);
   (_8 64); (_8 111); (_8 112); (_8 101); (_8 110); (_8 115); (_8 115); (_8 104); (_8 46); (_8 99); (_8 111); (_8 109); (_8 44); (_8 117); (_8 109); (_8 97);
   (_8 99); (_8 45); (_8 49); (_8 50); (_8 56); (_8 45); (_8 101); (_8 116); (_8 109); (_8 64); (_8 111); (_8 112); (_8 101); (_8 110); (_8 115); (_8 115);
   (_8 104); (_8 46); (_8 99); (_8 111); (_8 109); (_8 44); (_8 104); (_8 109); (_8 97); (_8 99); (_8 45); (_8 115); (_8 104); (_8 97); (_8 50); (_8 45);
   (_8 50); (_8 53); (_8 54); (_8 45); (_8 101); (_8 116); (_8 109); (_8 64); (_8 111); (_8 112); (_8 101); (_8 110); (_8 115); (_8 115); (_8 104); (_8 46);
   (_8 99); (_8 111); (_8 109); (_8 44); (_8 104); (_8 109); (_8 97); (_8 99); (_8 45); (_8 115); (_8 104); (_8 97); (_8 50); (_8 45); (_8 53); (_8 49);
   (_8 50); (_8 45); (_8 101); (_8 116); (_8 109); (_8 64); (_8 111); (_8 112); (_8 101); (_8 110); (_8 115); (_8 115); (_8 104); (_8 46); (_8 99); (_8 111);
   (_8 109); (_8 44); (_8 104); (_8 109); (_8 97); (_8 99); (_8 45); (_8 115); (_8 104); (_8 97); (_8 49); (_8 45); (_8 101); (_8 116); (_8 109); (_8 64);
   (_8 111); (_8 112); (_8 101); (_8 110); (_8 115); (_8 115); (_8 104); (_8 46); (_8 99); (_8 111); (_8 109); (_8 44); (_8 117); (_8 109); (_8 97); (_8 99);
   (_8 45); (_8 54); (_8 52); (_8 64); (_8 111); (_8 112); (_8 101); (_8 110); (_8 115); (_8 115); (_8 104); (_8 46); (_8 99); (_8 111); (_8 109); (_8 44);
   (_8 117); (_8 109); (_8 97); (_8 99); (_8 45); (_8 49); (_8 50); (_8 56); (_8 64); (_8 111); (_8 112); (_8 101); (_8 110); (_8 115); (_8 115); (_8 104);
   (_8 46); (_8 99); (_8 111); (_8 109); (_8 44); (_8 104); (_8 109); (_8 97); (_8 99); (_8 45); (_8 115); (_8 104); (_8 97); (_8 50); (_8 45); (_8 50);
   (_8 53); (_8 54); (_8 44); (_8 104); (_8 109); (_8 97); (_8 99); (_8 45); (_8 115); (_8 104); (_8 97); (_8 50); (_8 45); (_8 53); (_8 49); (_8 50);
   (_8 44); (_8 104); (_8 109); (_8 97); (_8 99); (_8 45); (_8 115); (_8 104); (_8 97); (_8 49); (_8 0); (_8 0); (_8 0); (_8 213); (_8 117); (_8 109);
   (_8 97); (_8 99); (_8 45); (_8 54); (_8 52); (_8 45); (_8 101); (_8 116); (_8 109); (_8 64); (_8 111); (_8 112); (_8 101); (_8 110); (_8 115); (_8 115);
   (_8 104); (_8 46); (_8 99); (_8 111); (_8 109); (_8 44); (_8 117); (_8 109); (_8 97); (_8 99); (_8 45); (_8 49); (_8 50); (_8 56); (_8 45); (_8 101);
   (_8 116); (_8 109); (_8 64); (_8 111); (_8 112); (_8 101); (_8 110); (_8 115); (_8 115); (_8 104); (_8 46); (_8 99); (_8 111); (_8 109); (_8 44); (_8 104);
   (_8 109); (_8 97); (_8 99); (_8 45); (_8 115); (_8 104); (_8 97); (_8 50); (_8 45); (_8 50); (_8 53); (_8 54); (_8 45); (_8 101); (_8 116); (_8 109);
   (_8 64); (_8 111); (_8 112); (_8 101); (_8 110); (_8 115); (_8 115); (_8 104); (_8 46); (_8 99); (_8 111); (_8 109); (_8 44); (_8 104); (_8 109); (_8 97);
   (_8 99); (_8 45); (_8 115); (_8 104); (_8 97); (_8 50); (_8 45); (_8 53); (_8 49); (_8 50); (_8 45); (_8 101); (_8 116); (_8 109); (_8 64); (_8 111);
   (_8 112); (_8 101); (_8 110); (_8 115); (_8 115); (_8 104); (_8 46); (_8 99); (_8 111); (_8 109); (_8 44); (_8 104); (_8 109); (_8 97); (_8 99); (_8 45);
   (_8 115); (_8 104); (_8 97); (_8 49); (_8 45); (_8 101); (_8 116); (_8 109); (_8 64); (_8 111); (_8 112); (_8 101); (_8 110); (_8 115); (_8 115); (_8 104);
   (_8 46); (_8 99); (_8 111); (_8 109); (_8 44); (_8 117); (_8 109); (_8 97); (_8 99); (_8 45); (_8 54); (_8 52); (_8 64); (_8 111); (_8 112); (_8 101);
   (_8 110); (_8 115); (_8 115); (_8 104); (_8 46); (_8 99); (_8 111); (_8 109); (_8 44); (_8 117); (_8 109); (_8 97); (_8 99); (_8 45); (_8 49); (_8 50);
   (_8 56); (_8 64); (_8 111); (_8 112); (_8 101); (_8 110); (_8 115); (_8 115); (_8 104); (_8 46); (_8 99); (_8 111); (_8 109); (_8 44); (_8 104); (_8 109);
   (_8 97); (_8 99); (_8 45); (_8 115); (_8 104); (_8 97); (_8 50); (_8 45); (_8 50); (_8 53); (_8 54); (_8 44); (_8 104); (_8 109); (_8 97); (_8 99);
   (_8 45); (_8 115); (_8 104); (_8 97); (_8 50); (_8 45); (_8 53); (_8 49); (_8 50); (_8 44); (_8 104); (_8 109); (_8 97); (_8 99); (_8 45); (_8 115);
   (_8 104); (_8 97); (_8 49); (_8 0); (_8 0); (_8 0); (_8 21); (_8 110); (_8 111); (_8 110); (_8 101); (_8 44); (_8 122); (_8 108); (_8 105); (_8 98);
   (_8 64); (_8 111); (_8 112); (_8 101); (_8 110); (_8 115); (_8 115); (_8 104); (_8 46); (_8 99); (_8 111); (_8 109); (_8 0); (_8 0); (_8 0); (_8 21);
   (_8 110); (_8 111); (_8 110); (_8 101); (_8 44); (_8 122); (_8 108); (_8 105); (_8 98); (_8 64); (_8 111); (_8 112); (_8 101); (_8 110); (_8 115); (_8 115);
   (_8 104); (_8 46); (_8 99); (_8 111); (_8 109); (_8 0); (_8 0); (_8 0); (_8 0); (_8 0); (_8 0); (_8 0); (_8 0); (_8 0); (_8 0); (_8 0);
   (_8 0); (_8 0); (_8 0); (_8 0); (_8 0); (_8 0); (_8 0); (_8 0)].

(* NoRes *)
Compute (run 101 ssh_parse_key_exchange
           test_malicious
           (mk_span 0 (N.of_nat (List.length test_malicious)))).
